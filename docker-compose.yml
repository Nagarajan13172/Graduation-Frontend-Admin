services:
  graduate-frontend-admin:
    image: graduate-frontend-admin
    container_name: graduate-frontend-admin
    restart: always
    hostname: graduate
    networks:
      default:
    labels:
      - traefik.enable=true
      - traefik.http.routers.graduate-frontend-admin.rule=Host(`graduate.periyaruniversity.ac.in`) && PathPrefix(`/admin`)
      - traefik.http.routers.graduate-frontend-admin.entrypoints=websecure
      - traefik.http.routers.graduate-frontend-admin.tls=true
      - traefik.http.routers.graduate-frontend-admin.tls.certresolver=myresolver

      - traefik.http.routers.graduate-frontend-admin.middlewares=ratelimit,strip-admin,admin-slash-redirect

      - traefik.http.middlewares.ratelimit.ratelimit.average=30
      - traefik.http.middlewares.ratelimit.ratelimit.burst=120
      - traefik.http.middlewares.ratelimit.ratelimit.period=3s
      - traefik.http.middlewares.ratelimit.ratelimit.sourceCriterion.ipStrategy.depth=1

      - traefik.http.middlewares.strip-admin.stripprefix.prefixes=/admin
      - traefik.http.middlewares.strip-admin.stripprefix.forceslash=true

      - traefik.http.middlewares.admin-slash-redirect.redirectregex.regex=^/admin$
      - traefik.http.middlewares.admin-slash-redirect.redirectregex.replacement=/admin/
      - traefik.http.middlewares.admin-slash-redirect.redirectregex.permanent=true

      - traefik.http.middlewares.admin-path-prefix.addprefix.prefix=/admin

      - traefik.http.middlewares.admin-spa-fallback.errors.status=404
      - traefik.http.middlewares.admin-spa-fallback.errors.service=graduate-frontend-admin
      - traefik.http.middlewares.admin-spa-fallback.errors.query=/index.html

      - traefik.http.services.graduate-frontend-admin.loadbalancer.server.port=80

    healthcheck:
      test: [ "CMD", "curl", "-fsS", "-o", "/dev/null", "http://localhost/" ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M

networks:
  default:
    name: edge
    external: true
